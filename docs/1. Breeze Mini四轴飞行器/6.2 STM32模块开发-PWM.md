title: 6.2 STM32模块开发-PWM

## 前言

这里主要讲解 **Breeze Mini** 的PWM输出功能模块，完整代码在工程目录下的 **Modules** 子目录下的 **stm32f10x_module_motor.c** 和 **stm32f10x_module_motor.h** 中，该代码主要产生PWM信号来控制空心杯电机的速度大小。

## 相关知识

### PWM简介

**PWM(Pulse Width Modulation)** 叫做 **脉冲宽度调制**，是一种利用数字输出来控制模拟电路的方法，简单来说就是对脉冲的宽度进行控制。

### STM32的PWM外设

STM32的PWM输出信号都是通过定时器产生的，除了TIM6和TIM7，其他的定时器都能够产生PWM输出。其中高级定时器TIM1能够产生最多7路的PWM信号输出，通用定时器能够产生最多4路的PWM信号。为了能够对STM32的PWM产生有更深地理解，这里先介绍与PWM相关的寄存器。

由于STM32的PWM信号是通过定时器产生的，所以如果要使用通用定时器TIM来产生PWM输出，除了要了解 **STM32驱动开发-通用与高级定时器** 中所讲解的寄存器外，还要介绍3个寄存器，这3个寄存器分别是 **捕获/比较模式寄存器(TIMx_CCMR[1...2])**、**捕获/比较使能寄存器(TIMx_CCER)** 和 **捕获/比较寄存器(TIMx_CCR[1...4])**。

#### TIMx_CCMR寄存器

该寄存器共有2个，分别为TIMx_CCMR1和TIMx_CCMR2。其中TIMx_CCMR1控制通道1和2(CH1, CH2)，TIMx_CCMR2控制通道3和4(CH3, CH4)，以下该寄存器各位描述：

该寄存器的有些位在不同模式下的功能是不一样的，对该寄存器的详细说明，可以参考 **STM32寄存器手册** 第288页，14.4.7一节。这里要额外说明的是 **模式设置位OCxM**，该位由3位组成，所以共可以配置成7种模式，我们这里使用的是PWM模式，所以需要设置成 **110** 或者 **111**。设置值的差别仅在于 **输出电平的极性会相反**。

#### TIMx_CCER寄存器

该寄存器控制各个输入输出通道的开关，其各位描述如下图所示：

该寄存使用起来比较简单，想要定时器从第几个通道输出PWM信号，就置第几个CC[1...4]E为1，比如想要从通道2输出PWM信号，就需要将 **CC2E** 置为1，更加详细的用法可以参考 **STM32寄存器手册** 第292页，14.4.9一节。

#### TIMx_CCR寄存器

TIMx_CCR一共有4个，分别对应4路输出通道，该寄存器的各位描述为：

在输出模式下，该寄存器的值会与CNT的值进行比较，根据比较结果来产生相应的动作。修改该寄存器的值就可以控制PWM的输出脉宽。

### 库函数配置PWM

PWM相关的库函数在 **FWLib** 目录下的 **stm32f10x_tim.c** 和 **stm32f10x_tim.h** 中。

## 硬件连接

## 软件设计

## 参考

* [STM32开发指南-库函数版本_V3.1.pdf](https://documents-1256406063.cos.ap-shanghai.myqcloud.com/STM32F1%E5%BC%80%E5%8F%91%E6%8C%87%E5%8D%97-%E5%BA%93%E5%87%BD%E6%95%B0%E7%89%88%E6%9C%AC_V3.1%20.pdf), 正点原子, [ALLENTEK](http://www.alientek.com/).