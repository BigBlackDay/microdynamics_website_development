title: 6.1 STM32模块开发-LED

## 前言

这里主要讲解 **Breeze Mini** 的LED相关功能代码， 代码在工程目录下的 **Modules** 子目录下的 **stm32f10x_module_led.c** 和 **stm32f10x_module_led.h** 中。

## 相关知识

STM32要实现LED的亮与灭其实就是实现GPIO口的高低电平控制，由于STM32的IO口要相比51要复杂得多，所以为了更好地理解，这里先简单介绍一下STM32的IO口。STM32的GPIO口可以被配置成8种模式：

```c
1. 输入浮空
2. 输入上拉
3. 输入下拉
4. 模拟输入
5. 开漏输出
6. 推挽输出
7. 推挽复用
8. 开漏复用
```

STM32的每个IO口都可以自由编程，但IO口的寄存器必须要按32位字被访问，STM32的IO口很多都是5V兼容的，这些IO口在与5V电平标准的外设连接时很有优势，具体哪些IO口是5V兼容的可以从芯片的datasheet管脚描述章节查到(I/O Level标有FT的就是5V兼容的)。

STM32的每个IO口都是由7个寄存器控制的，这7个寄存器分别是：

```c
2个32位的数据寄存器IDR和ODR
2个32位的端口配置寄存器CRL和CRH
1个16位的复位寄存器BRR
1个32位的锁存寄存器LCKR
1个32位的置位/复位寄存器BSRR
```

CRL和CRH寄存器控制IO口的模式和输出速率，STM32的IO口位配置表如下所示：

STM32输出模式如下表所示：

接着再来看看端口低位配置寄存器 **(Config Register Low, i.e. CRL)** 的各位描述，该寄存器的复位值 **0X44444444**，从上图中可以看出，复位值其实就是配置端口为浮空输入模式，而且CRL控制着IO端口的低8个，每个IO端口的位占用CRL的4个位，其中高两位为配置 **CNF**，低两位配置 **MODE**：

```c
CNF
00：通用推挽输出
01：通用开漏输出
10：复用推挽输出
11：复用开漏输出

MODE
00：输入模式
01：输出模式(最大速率10MHz)
10：输出模式(最大速率2MHz)
11：输出模式(最大速率50MHz)
```

CRH的作用和CRL的一样，只是CRL控制的是低8个端口，而CRH控制的是高8个端口，现在讲解如何使用固件库来设置GPIO的工作模式和相关参数，操作GPIO的官方固件库代码在 **stm32f10x_gpio.c** 和 **stm32f10x_gpio.h** 中。在使用固件库开发过程中，操作CRH或者CRL寄存器来配置IO口的模式和速度是通过GPIO初始化函数

```c
void GPIO_Init(GPIO_TypeDef* GPIOx, GPIO_InitTypeDef* GPIO_InitStruct)
```

来实现的，这个函数有两个参数，第一个参数用来指定操作的GPIO，取值范围 **GPIOA~GPIOG**。

!!! info "注意"
    GPIOA~GPIOG只是对于 **STM32F103大容量系列产品来说的**，**Breeze Mini** 所选用的 **STM32F103TBU6** 只有完整的GPIOA口、部分GPIOB和部分GPIOD。

第二个参数为 **初始化结构体指针**，结构体类型为 **GPIO_InitTypeDef**，可以通过双击 **"GPIO_InitTypeDef"** 后右键点击 **"Go to definition of..."** 跳转到其定义处：

```c
typedef struct
{
    uint16_t GPIO_Pin;
    GPIOSpeed_TypeDef GPIO_Speed;
    GPIOMode_TypeDef GPIO_Mode;
}GPIO_InitTypeDef;
```

通过 **初始化结构体GPIO_InitTypeDef** 来初始化GPIO的一般格式为：

```c
GPIO_InitTypeDef GPIO_InitStructure;
GPIO_InitStructure.GPIO_Pin   = GPIO_Pin_5;
GPIO_InitStructure.GPIO_Mode  = GPIO_Mode_Out_PP;
GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;
GPIO_Init(GPIOA, &GPIO_InitStructure);
```

这段代码先定义了一个GPIO口的初始化结构体 **GPIO_InitTypeDef** 类型的变量 **GPIO_InitStructure**，然后第2行设置待配置管脚为 **GPIOA第5个端口**，第3行设置端口工作在 **推挽输出模式**，第4行设置端口最大工作速度为 **50MHz**。第5行则调用函数对设置好的参数进行初始化。

## 硬件连接

## 软件设计

## 参考

* [STM32开发指南-库函数版本_V3.1.pdf](https://documents-1256406063.cos.ap-shanghai.myqcloud.com/STM32F1%E5%BC%80%E5%8F%91%E6%8C%87%E5%8D%97-%E5%BA%93%E5%87%BD%E6%95%B0%E7%89%88%E6%9C%AC_V3.1%20.pdf), 正点原子, [ALLENTEK](http://www.alientek.com/).