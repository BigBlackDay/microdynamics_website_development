title: 5.5 STM32驱动开发-通用与高级定时器

## 前言

这里主要讲解 **Breeze Mini** 的内部定时器，完整代码在工程目录下的 **Drivers** 子目录下的 **stm32f10x_driver_timer.c** 和 **stm32f10x_driver_timer.h** 中，该代码主要是驱动定时器产生不同长度的定时中断来控制main函数调用相应函数，实现中断嵌套功能。同时也是为了后面讲解PWM功能模块做铺垫。

## 相关知识

### 通用定时器

STM32F1系列的通用定时器是一个通过可编程预分频器 **(PSC)** 驱动的16位自动装载计数器 **(CNT**)，其被用于：测量输入信号的脉冲长度 **(输入捕获)** 和产生输出波形 **(输出比较和脉冲宽度调制)**，使用PSC和RCC时钟控制预分频器，脉冲长度和波形周期可以在几个微秒到几个毫秒之间调整。STM32的每个通用定时器都是独立的，可以单独使用，每个通用定时器功能包括：

1. 具有一个16位向上、向下或向上向下自动装载计数器(TIMx_CNT)

2. 具有一个16位可编程预分频器(TIMx_PSC)，计数器时钟频率的分频系数范围为1~65535

3. 拥有4个独立通道，可以被配置成如下功能：

    1. 输入捕获

    2. 输出比较

    3. PWM输出(边缘或中间对齐模式)

    4. 单脉冲模式输出

4. 具有可使用外部信号 **(TIMx_ETR)** 控制定时器与定时器互联的同步电路

5. 具有事件中断响应能力，事件源有：

    1. 更新：计数器溢出和计数器初始化(通过软件或内部/外部触发)

    2. 触发事件：计数器启动、停止、初始化或由内部/外部触发计数

    3. 输入捕获

    4. 输出比较

    5. 针对定位的增量(正交)编码器和霍尔传感器电路

    6. 触发输入作为外部时钟或按周期的电流管理

更多内容可以直接参考 **STM32寄存器手册** 第253页通用定时器一章，为了能够更加清楚地了解通用定时器的功能，下面会介绍一些与定时功能密切相关的寄存器。

#### TIMx_CR1寄存器

TIMx_CR1是TIMx的控制寄存器，该寄存器的各位描述如下图所示：

从上图描述可以看出，TIMx_CR1的第0位控制计数使能，只有该位置1，才能开启定时器计数。第4位设置计数的方向，第5和6位设置计数对齐方式，第8和9位设置定时器时钟分频因子。

#### TIMx_DIER寄存器

TIMx_DIER是TIMx的DMA/中断使能寄存器，该寄存器各位描述如下图所示：

这里只需要关注该寄存器的第0位，该位是更新中断使能位，设置该位为1则允许更新事件产生中断。

#### TIMx_PSC寄存器

TIMx_PSC是TIMx的预分频寄存器，该寄存器用于对时钟进行分频，然后提供给计数器，以作为计数器的时钟。该寄存器的各位描述如下图所示：

这里定时器的时钟来源有4个：

1. 内部时钟(CK_INT)

2. 外部时钟模式1(外部输入脚TIx)

3. 外部时钟模式2(外部触发输入ETR)

4. 内部触发输入(使用另一个定时器为本定时器提供时钟)

具体选择哪个时钟源可以通过 **TIMx_SMCR** 寄存器的对应位来设置，这里的CK_INT时钟是从APB1总线时钟倍频得来的，而高级定时器的内部时钟来自于APB2总线时钟。

#### TIMx_CNT寄存器

TIMx_CNT是TIMx的计数寄存器，该寄存器存储有当前定时器的计数值。

#### TIMx_ARR寄存器

TIMx_ARR是TIMx的自动装载计数器，该寄存器在物理上对应着2个寄存器，1个是可以被操作的，被称为预装载寄存器，还有1个是被操作不了的，这个操作不了的寄存器被称为 **影子寄存器**。实际上真正起作用的是影子寄存器，根据TIMx_CR1寄存器中APRE位的设置：

```c
APRE = 0 //预装载寄存器的内容可以随时送到影子寄存器中，两者是相连的
APRE = 1 //只有在每次更新事件时才把预装载寄存器的内容送到影子寄存器中
```

该寄存器的各位描述如下图所示：

#### TIMx_SR寄存器

TIMx_SR是TIMx的状态寄存器，该寄存器用来标记定时器事件和中断是否发生，该寄存器各位描述如下图所示：

关于定时器更多的详细描述请参考 **STM32寄存器手册** 第282页，只要对上面介绍的寄存器进行设置，就可以使用通用定时器产生要求的延时信号。

### 高级定时器

### 固件库配置定时器

定时器相关的库函数在 **FWLib** 目录下的 **stm32f10x_tim.c** 和 **stm32f10x_tim.h** 中。

## 硬件连接

## 软件设计

## 参考

* [STM32开发指南-库函数版本_V3.1.pdf](https://documents-1256406063.cos.ap-shanghai.myqcloud.com/STM32F1%E5%BC%80%E5%8F%91%E6%8C%87%E5%8D%97-%E5%BA%93%E5%87%BD%E6%95%B0%E7%89%88%E6%9C%AC_V3.1%20.pdf), 正点原子, [ALLENTEK](http://www.alientek.com/).
